# =============================================================================
# EcoNeTool - R Validation
# =============================================================================
# Comprehensive R checks that run on releases, PRs, or manual trigger.
# These checks are more thorough but slower than the main CI.
#
# Checks performed:
# - R dependency installation
# - All R file syntax validation
# - Full lintr scan of R/ directory
# - Unit test execution (tests that can run without external APIs)
# =============================================================================

name: R Validation

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      lint_all:
        description: 'Lint all R files (slow)'
        required: false
        default: 'false'
        type: boolean

  # Run on PRs (R file changes only)
  pull_request:
    branches: [master, main, develop]
    paths:
      - '**.R'
      - '.github/workflows/r-check.yml'

  # Run on releases
  release:
    types: [published]

  # Run weekly to catch issues
  schedule:
    - cron: '0 6 * * 1'  # Monday 6am UTC

jobs:
  # ===========================================================================
  # R environment validation
  # ===========================================================================
  r-validation:
    name: R Validation
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.1'
          use-public-rspm: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev \
            libgdal-dev \
            libgeos-dev \
            libproj-dev \
            libudunits2-dev

      - name: Install R dependencies
        run: |
          install.packages(c(
            "shiny", "lintr", "bs4Dash",
            "igraph", "dplyr", "tidyr", "readr", "jsonlite",
            "shinyWidgets", "DT", "visNetwork"
          ), repos = "https://cloud.r-project.org")
        shell: Rscript {0}
        continue-on-error: true

      - name: Validate all R file syntax
        run: |
          r_files <- list.files(
            c(".", "R", "R/config", "R/functions", "R/functions/ecopath",
              "R/functions/rpath", "R/modules", "R/ui"),
            pattern = "\\.R$",
            full.names = TRUE,
            recursive = FALSE
          )
          r_files <- r_files[!grepl("safeBackup", r_files)]

          cat(sprintf("Checking %d R files...\n", length(r_files)))
          errors <- 0
          for (f in r_files) {
            result <- tryCatch({ parse(file = f); NULL },
                               error = function(e) e$message)
            if (!is.null(result)) {
              cat(sprintf("FAIL %s: %s\n", f, result))
              errors <- errors + 1
            }
          }
          if (errors > 0) {
            cat(sprintf("\n%d file(s) with parse errors\n", errors))
            quit(status = 1)
          }
          cat("All R files have valid syntax\n")
        shell: Rscript {0}

      - name: Validate test file syntax
        run: |
          test_files <- list.files("tests", pattern = "\\.R$",
                                   full.names = TRUE, recursive = TRUE)
          test_files <- test_files[!grepl("safeBackup", test_files)]

          cat(sprintf("Checking %d test files...\n", length(test_files)))
          errors <- 0
          for (f in test_files) {
            result <- tryCatch({ parse(file = f); NULL },
                               error = function(e) e$message)
            if (!is.null(result)) {
              cat(sprintf("FAIL %s: %s\n", f, result))
              errors <- errors + 1
            }
          }
          if (errors > 0) {
            cat(sprintf("\n%d test file(s) with parse errors\n", errors))
            quit(status = 1)
          }
          cat("All test files have valid syntax\n")
        shell: Rscript {0}

      - name: Lint app.R
        run: |
          cat("Running lintr on app.R...\n")
          results <- lintr::lint("app.R")
          cat("Found", length(results), "issues\n")
          if (length(results) > 0) {
            print(results)
          }
        shell: Rscript {0}
        continue-on-error: true

      - name: Lint R/functions (key files)
        run: |
          key_files <- c(
            "R/functions/validation_utils.R",
            "R/functions/error_logging.R",
            "R/functions/metaweb_core.R"
          )
          for (f in key_files) {
            if (file.exists(f)) {
              cat("Linting", f, "...\n")
              results <- lintr::lint(f)
              if (length(results) > 0) {
                cat("  Found", length(results), "issues\n")
              } else {
                cat("  No issues\n")
              }
            }
          }
        shell: Rscript {0}
        continue-on-error: true

      - name: Full lint scan (if requested)
        if: github.event.inputs.lint_all == 'true'
        run: |
          cat("Running full lintr scan on R/ directory...\n")
          results <- lintr::lint_dir("R/")
          cat("Total issues found:", length(results), "\n")
          if (length(results) > 0) {
            by_file <- split(results, sapply(results, function(x) x$filename))
            for (file in names(by_file)) {
              cat("\n", file, ":", length(by_file[[file]]), "issues\n")
            }
          }
        shell: Rscript {0}
        continue-on-error: true

  # ===========================================================================
  # Dependency check
  # ===========================================================================
  dependency-check:
    name: Check R dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract required packages from app.R
        run: |
          echo "Packages loaded in app.R:"
          grep -E "^library\(|^require\(" app.R | sed 's/library(\|require(//g' | sed 's/)//g' | sort -u
